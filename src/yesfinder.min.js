/*
* YesFinder v1.2.0
* Steven Ye
* Email: steven_ye@foxmail.com
* Date: 2016-4-3
*/;
(function(b,h,q,r){var l=function(a,f,e){this.$ele=a;this.callback=e;this.file=this.folder="";this.upfiles=[];this.options=b.extend({},b.fn.YesFinder.defaults,f)};l.prototype={init:function(){var a=this;this.get("init").then(function(b){a.baseurl=b.baseurl;a.iconurl=b.iconurl},function(){alert("No response from the server.")});this.loadBody();this.loadMenu();this.loadFolders()},loadBody:function(){function a(){b(h).width();var a=b(h).height();c.css("height",a-30);g.css("height",a-95)}var f=this,e=
this.$ele,d;d='<table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td width="20%"><div class="fm-sidebar"><h2>Folders</h2><ul class="folder-list">';d+='<li class="root"><a class="active" href=""> Home</a></li><ul></ul>';d+='</ul></div></td><td width="80%">';d+='<div class="fm-header">';d+='   <ul class="fm-toolbar"></ul>';d+='   <p>Total <span class="files_num">0</span> File(s).</p>';d+="</div>";d+='<div class="fm-body">';d+='   <ul class="file-list"></ul>';d+="</div></td></tr></table>";
d+='<div class="cover"></div>';d+='<div class="modal"></div>';e.html(d);var c=b(".fm-sidebar",e),g=b(".fm-body",e);a();b(h).resize(a);b.smartMenu&&g.smartMenu([[{text:"Upload",func:function(){f.modal("upload")}},{text:"Refresh",func:function(){f.refresh()}}]],{name:"fm-body",textLimit:18})},loadMenu:function(){var a=this,f=this.$ele,e=this.options.menu.split(","),d=b(".fm-toolbar",f).html("");b.each({View:{text:"View",func:function(){a.view(a.file)}},Upload:{text:"Upload",func:function(){a.modal("upload")}},
Refresh:{text:"Refresh",func:function(){a.refresh()}},Delete:{text:"Delete",func:function(){a.delete(a.file)}},Download:{text:"Download",func:function(){a.download(a.file)}},Settings:{text:"Settings",func:'<ul><li><label><input type="checkbox" name="filename" checked> Filename</label></li><li><label><input type="checkbox" name="filetime"> Filetime</label></li><li><label><input type="checkbox" name="filesize"> Filesize</label></li></ul>'},Help:{text:"Help",func:"<div>YesFinder need PHP5.4+ <br/> And JQuery 1.11.0+</div>"}},
function(a,g){if(0<=e.indexOf(a)){var f=b('<li class="'+a.toLowerCase()+'">'+g.text+"</li>").appendTo(d);"function"===typeof g.func?f.click(g.func):f.append(g.func)}});b(".settings input:checkbox",d).each(function(){b(this).click(function(){b(this).is(":checked")?b(".file-list li."+b(this).attr("name"),f).show():b(".file-list li."+b(this).attr("name"),f).hide()})})},loadFolders:function(){function a(d){var c="";b.each(d,function(b,d){c+='<li><a href="'+d.path+'">'+d.name+"</a>";"object"==typeof d.son&&
(c+="<ul>",c+=a(d.son),c+="</ul>");c+="</li>"});return c}var f=this,e=this.$ele;this.get("folders","/").then(function(d){if(d.error)return b(".folder-list>ul",e).html("<p>"+d.error+"</p>");b(".folder-list>ul",e).html(a(d));var c=[[{text:"New Folder",func:function(){var a=b(this).attr("href"),c=f.modal("newfolder"),d=b("input",c);b("button",c).click(function(){var b=d.val();if(!b)return alert("Please input a folder name.");if(!a)return alert("Please choose a folder first.");f.newFolder(a,b)})}},{text:"Rename",
func:function(){var a=b(this).attr("href");if(""==a||"/"==a)return alert("The root cannot be renamed.");var c=a.substr(a.lastIndexOf("/")+1),d=f.modal("folder"),e=b("input[type=text]",d).val(c),c=b("button",d);e.next("span").text("");c.click(function(){var b=e.val();if(!b)return alert("Please input a newname.");if(!a)return alert("Please choose a folder first.");f.rename(a,b,!0)})}},{text:"Delete",func:function(){f.delFolder(b(this).attr("href"))}}]];b(".folder-list a",e).each(function(){b(this).click(function(a){a.preventDefault();
f.folder=b(this).attr("href");f.loadFiles();f.file="";b(".folder-list a.active",e).removeClass("active");b(this).addClass("active")});b.smartMenu&&b(this).smartMenu(c,{name:"folders",textLimit:18});b(this).attr("href")===f.folder&&b(this).click()})},function(){b(".folder-list>ul",e).html("<p>No response from the server.</p>")})},loadFiles:function(){var a=this,f=this.$ele,e=b(".file-list",f),d=[[{text:"Select",func:function(){a.select(b(this).find("input[type=checkbox]").val())}},{text:"View",func:function(){var c=
b(this).find("input[type=checkbox]").val();a.view(c)}},{text:"Download",func:function(){a.download(b(this).find("input[type=checkbox]").val())}}],[{text:"Rename",func:function(){var c=b(this).find("input[type=checkbox]").val(),d=c,f="";-1<c.lastIndexOf(".")&&(d=c.substr(0,c.lastIndexOf(".")),f=c.substr(c.lastIndexOf(".")));var e=a.modal("file"),h=b("input",e),n=b("button",e);h.val(d);h.next("span").text(f);e.find(".modal-header b").text("File Rename");n.click(function(){var b=h.val();c?b?b==d?alert("The name is same"):
a.rename(c,b):alert("Please input a new name."):alert("Please choose a file first.")})}}],[{text:"Delete",func:function(){a.delete(b(this).find("input[type=checkbox]").val())}}]];this.get("files",this.folder).then(function(c){if(c.error)return e.html("<p>"+c.error+"</p>");if(!c.length)return e.html("<h4>No files in this folder.</h4>");var g="";b.each(c,function(b,c){var d=c.filename.substr(c.filename.lastIndexOf(".")),f=a.iconurl+c.fileicon;-1!==".jpg.jpeg.png.gif.bmp".indexOf(d.toLowerCase())&&(f=
"/"==a.folder?a.baseurl:a.baseurl+a.folder+"/",f+=c.filename);g+='<li><label><ul><li class="fileicon">';g+='<img src="'+f+'"/>';g+='</li><li class="filename">'+c.filename+"</li>";g+='<li class="filetime">'+c.filetime+"</li>";g+='<li class="filesize">'+c.filesize+"</li>";g+='</ul><input type="checkbox" value="'+c.filename+'"/></label></li>'});e.html(g);b(".files_num",this.$ele).text(c.length);a.file="";e.find("label").each(function(){var c=b(this).find("input[type=checkbox]").val();b(this).click(function(){a.file=
c;b("li.active",e).removeClass("active");b(this).parent().addClass("active")});b(this).dblclick(function(){a.select(c)});b.smartMenu&&b(this).smartMenu(d,{name:"files",textLimit:18})});b(".settings input:checkbox",f).each(function(){b(this).is(":checked")?b("li."+b(this).attr("name"),e).show():b("li."+b(this).attr("name"),e).hide()})},function(){e.html("<p>No response from the server.</p>")})},modal:function(a,b,e){var d=this,c={},g=new p(this.$ele),h=g.modal;a=a||"";var k="function"==typeof b?b:
e;if(g[a])return g[a]();"upload"==a?(c.title="File Upload",c.content="<ul><li><h4>Please add the files to upload.</h4></li></ul>",c.footer='<input type="file" id="upfile" multiple/><button id="addBtn" class="fl">+ Add Files</button><button id="upload" class="fr">Upload</button><div class="clearfix"></div>',g.init(c,function(){d.modalUpload();"function"===typeof k&&k()})):"view"==a?(c.title="Image View",c.content=b?'<img src="'+b+'" alt=""/>':"<p>No file</p>",g.init(c,k),h.find(".modal-content").css({textAlign:"center",
overflow:"inherit",padding:5})):(c.title="file"==a?"File Rename":"folder"==a?"Folder Rename":"New Folder",c.content='<br><table align="center" width="100%"><tr><td align="center"><input type="text" class="yes_target"/>  <span class="yes_ext"></span> <button type="button" class="yes_btn_ok">Submit</button></td></tr></table>',g.init(c,k));g.show();return h},modalUpload:function(){function a(){var c=e.find(".modal-content");if(0==f.upfiles.length)return c.html("<ul><li><h4>Please add the files to upload.</h4></li></ul>");
c.html("");b.each(f.upfiles,function(d,e){var h=b('<ul><li class="col-8"><b>'+e.name+'</b></li><li class="col-2">'+(e.size/1024).toFixed(2)+' KB</li><li class="col-2 text-right"><button>Cancel</button></li></ul>');b("button",h).click(function(){f.upfiles.splice(d,1);a()});h.appendTo(c)})}var f=this,e=b(".modal",this.$ele),d=e.find("button");a();d.eq(1).click(function(){f.upload().then(function(b){b.error?alert("Failed: "+b.error):(f.refresh(),f.upfiles=[],a(),e.html(""),alert("Files Uploaded Successfully!\n\n"+
b+"."),f.modal("hide"))},function(a){alert(a)})});d.eq(0).click(function(){var c=b("#upfile",e),d=c.clone().val("");c.after(d);c.remove();d.change(function(){b.each(this.files,function(a,b){f.upfiles.push(b)});a()});d.click()})},newFolder:function(a,b){if(!b)return alert("Please give a folder name first.");var e=this;this.get("newfolder",a+"/"+b).then(function(a){if(a.error)return alert(a.error);e.loadFolders();e.modal("hide")},function(a){alert("Failed to create a new folder.\n"+a)})},delFolder:function(a){if(!a)return alert("Please choose a folder first.");
confirm('Are you sure to delete this folder "'+a+'"?')&&(a=this.get("delfolder",a),a.error?alert(a.error):a?(this.loadFolders(),alert("The folder is deleted.")):alert("Failed to delete the folder.\nThere may be some files and/or folders in it."))},view:function(a){if(!a)return alert("Please choose a file first.");var b=a.substr(a.lastIndexOf("."));if(-1===".jpg.jpeg.gif.png.bmp".indexOf(b.toLowerCase()))return alert("Only image file can be viewed.");this.folder&&(a=this.folder+"/"+a);a=this.baseurl+
"/"+a;this.modal("view",a)},delete:function(a){if(!a)return alert("Please choose a file first.");if(confirm("Are you sure to delete this file: "+a+" ?")){var b=this;this.get("delete",this.folder+"/"+a).then(function(a){if(a.error)return alert(a.error);b.refresh()},function(){alert("Something wrong on the server to delete the file.")})}},rename:function(a,b,e){var d=this,c=e?"change":"alter";a=e?a:this.folder+"/"+a;this.get(c,a+"||"+b).then(function(a){if(a.error)return alert(a.error);c=e?d.loadFolders():
d.loadFiles();d.modal("hide")},function(){alert("Failed to rename it")})},download:function(a){if(!a)return alert("Please choose a file first.");a=this.folder+"/"+a;h.location=this.options.url+"?action=download&path="+a},refresh:function(){this.loadFiles()},select:function(a){""!=this.folder&&"/"!=this.folder&&(a=this.folder+"/"+a);this.callback?this.callback.call(this,a):"function"===typeof parent.yesfinder?parent.yesfinder(a):"function"===typeof h.yesfinder&&h.yesfinder(a)},get:function(a,f){var e=
this.options,d=b.Deferred();b.ajax({url:e.url,data:{action:a,path:f,type:e.filetype},type:"get",cache:!1,dataType:"json"}).then(function(a){d.resolve(a)},function(a){d.reject(a)});return d.promise()},upload:function(){if(0==this.upfiles.length)return alert("Please add the files to upload.");var a=b.Deferred(),f=new FormData;b.each(this.upfiles,function(a,b){f.append("file[]",b)});b.ajax({url:this.options.url+"?action=upload&path="+this.folder,data:f,type:"POST",cache:!1,contentType:!1,processData:!1,
dataType:"json"}).then(function(b){a.resolve(b)},function(b){a.reject(b)});return a.promise()}};var p=function(a){this.cover=a.find(".cover");this.modal=a.find(".modal");this.show=function(){this.cover.fadeIn();this.modal.fadeIn()};this.hide=function(){this.cover.fadeOut();this.modal.fadeOut()};this.init=function(a,e){function d(){var a=b(h).width(),c=g.width(),d=(b(h).height()-g.height())/2;0>d?d=0:200<d&&(d=200);c=550>a?a:550;g.css({left:(a-c)/2,top:d,width:c})}var c=this,g=this.modal.html(""),
m=b.extend({},{title:"",content:""},a),k=b('<div class="modal-header">').appendTo(g),l=b("<b></b>").appendTo(k),k=b('<a class="close" title="close">&times;</a>').appendTo(k),n=b('<div class="modal-content"></div>').appendTo(g);k.click(function(){c.hide()});l.text(m.title);n.html(m.content);m.footer&&g.append('<div class="modal-footer">'+m.footer+"</div>");d();b(h).resize(d);"function"==typeof e&&e()}};b.fn.YesFinder=function(a,f){"function"===typeof a&&(f=a,a={});return this.addClass("yesFinder").each(function(){(new l(b(this),
a,f)).init()})};b.fn.yesFinder=b.fn.YesFinder;b.fn.YesFinder.defaults={url:"php/connector.php",filetype:"",menu:"View,Upload,Refresh,Delete,Download,Settings,Help"}})(jQuery,window,document);